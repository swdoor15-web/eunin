// ================================================
// ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤ - Airtable Automation Script
// ì‘ì„±ì¼: 2025-12-18
// ìš©ë„: Meta ë¦¬ë“œ ìˆ˜ì‹  ì‹œ Worker í˜¸ì¶œ (ì´ë©”ì¼ + í…”ë ˆê·¸ë¨)
// íŠ¸ë¦¬ê±°: When record is created â†’ Run a script
// íë¦„: Meta Lead â†’ Make â†’ Airtable â†’ Worker(ì•Œë¦¼)
// ================================================

/**
 * Airtable Automation ì„¤ì • ë°©ë²•:
 *
 * 1. Airtable ì ‘ì† â†’ Base ì—´ê¸° (TO_BE_SET)
 * 2. ìƒë‹¨ "Automations" í´ë¦­
 * 3. "+ Create automation" í´ë¦­
 * 4. ì´ë¦„: "Meta ë¦¬ë“œ ì•Œë¦¼ ë°œì†¡"
 *
 * 5. íŠ¸ë¦¬ê±° ì„¤ì •:
 *    - "When record is created" ì„ íƒ
 *    - Table: "ê³ ê°ì •ë³´" (ë˜ëŠ” ì‹¤ì œ í…Œì´ë¸”ëª…)
 *
 * 6. ì•¡ì…˜ ì„¤ì •:
 *    - "+ Add action" í´ë¦­
 *    - "Run a script" ì„ íƒ
 *    - ì•„ë˜ ì½”ë“œ ì „ì²´ ë³µì‚¬ â†’ ë¶™ì—¬ë„£ê¸°
 *
 * 7. Input variables ì„¤ì • (Configure í´ë¦­):
 *    - recordId: Record ID ì„ íƒ
 *
 * 8. "Test step" í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸
 * 9. ì„±ê³µ ì‹œ í† ê¸€ ON (í™œì„±í™”)
 */

// ================================================
// Input Variables ì„¤ì •
// ================================================

let inputConfig = input.config();
let recordId = inputConfig.recordId;

console.log('ğŸ” ë°›ì€ recordId:', recordId);

// ================================================
// í…Œì´ë¸”ì—ì„œ ë ˆì½”ë“œ ê°€ì ¸ì˜¤ê¸°
// ================================================

let table = base.getTable('ê³ ê°ì •ë³´');
let record = await table.selectRecordAsync(recordId);

if (!record) {
    console.log('âŒ ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    output.set('status', 'error');
    output.set('error', 'Record not found');
    return;
}

console.log('ğŸ“‹ ë ˆì½”ë“œ ì¡°íšŒ ì„±ê³µ:', record.id);

// ================================================
// í•„ë“œê°’ ì¶”ì¶œ
// ================================================

const data = {
    no: record.getCellValue('no') || '-',
    í”Œë«í¼: record.getCellValue('í”Œë«í¼') || 'Meta',
    ê´‘ê³ ëª…: record.getCellValue('ê´‘ê³ ëª…') || '-',
    ì§€ì—­: record.getCellValue('ì§€ì—­') || '-',
    ì´ë¦„: record.getCellValue('ì´ë¦„') || '-',
    ì—°ë½ì²˜: record.getCellValue('ì—°ë½ì²˜') || '-',
    ìƒí˜¸ëª…: record.getCellValue('ìƒí˜¸ëª…') || '-',
    ì—…ì¢…: record.getCellValue('ì—…ì¢…') || '-',
    ì§ì „ë…„ë„ë§¤ì¶œ: record.getCellValue('ì§ì „ë…„ë„ë§¤ì¶œ') || '-',
    í•„ìš”ìê¸ˆ: record.getCellValue('í•„ìš”ìê¸ˆ') || '-',
    ìƒë‹´í¬ë§ì‹œê°„: record.getCellValue('ìƒë‹´í¬ë§ì‹œê°„') || '-'
};

console.log('ğŸ“‹ ì¶”ì¶œëœ ë°ì´í„°:', JSON.stringify(data));

// ================================================
// Worker í˜¸ì¶œ
// ================================================

const WORKER_URL = 'https://euninbiz.swdoor15.workers.dev/';

try {
    console.log('ğŸš€ Worker í˜¸ì¶œ ì‹œì‘...');

    const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok && result.success) {
        console.log('âœ… Worker í˜¸ì¶œ ì„±ê³µ!');
        console.log('ğŸ“§ ì´ë©”ì¼:', result.email?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
        console.log('ğŸ“± í…”ë ˆê·¸ë¨:', result.telegram?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

        output.set('status', 'success');
        output.set('email_status', result.email?.success ? 'sent' : 'failed');
        output.set('telegram_status', result.telegram?.success ? 'sent' : 'failed');
    } else {
        console.log('âŒ Worker í˜¸ì¶œ ì‹¤íŒ¨');
        console.log('ì—ëŸ¬:', JSON.stringify(result));

        output.set('status', 'failed');
        output.set('error', result.error || 'Unknown error');
    }

} catch (error) {
    console.log('âŒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    console.log('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);

    output.set('status', 'error');
    output.set('error', error.message);
}

// ================================================
// ì„¤ì • ì •ë³´
// ================================================

/**
 * Airtable:
 * - Base ID: TO_BE_SET (ë¹„ì   Base ë³µì‚¬ í›„ ì„¤ì •)
 * - Table: ê³ ê°ì •ë³´
 * - Share URL: TO_BE_SET
 *
 * Worker:
 * - URL: https://euninbiz.swdoor15.workers.dev/
 *
 * ì´ë©”ì¼ ìˆ˜ì‹ :
 * - TO: swdoor166@naver.com
 * - BCC: mkt@polarad.co.kr
 *
 * í…”ë ˆê·¸ë¨:
 * - Chat ID: -1003635343656
 *
 * ë¸Œëœë“œ ì •ë³´:
 * - íšŒì‚¬ëª…: ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤
 * - ëŒ€í‘œì: ì¡°ì€ì˜ˆ
 * - ëŒ€í‘œë²ˆí˜¸: 010-6660-5118
 */
