// ================================================
// ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤ - Meta Lead ì•Œë¦¼ Worker
// URL: https://euninbiz.swdoor15.workers.dev/
// ì‘ì„±ì¼: 2025-12-18
// ìš©ë„: Airtable Automationì—ì„œ í˜¸ì¶œ (ì´ë©”ì¼ + í…”ë ˆê·¸ë¨)
// íë¦„: Meta Lead â†’ Make â†’ Airtable â†’ Worker(ì•Œë¦¼)
// ================================================

// ================================================
// ì‹¤ì œ í† í°ì€ .env ë˜ëŠ” Cloudflare ëŒ€ì‹œë³´ë“œì—ì„œ ì„¤ì •
// ================================================
const CONFIG = {
  BRAND: {
    NAME: 'ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤',
    CEO: 'ì¡°ì€ì˜ˆ',
    PHONE: '010-6660-5118',
    EMAIL: 'swdoor166@naver.com'
  },
  EMAIL: {
    FROM: 'ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤ <noreply@mail.policy-fund.online>',
    TO: 'swdoor166@naver.com',
    BCC: 'mkt@polarad.co.kr'
  },
  RESEND: {
    API_KEY: 'YOUR_RESEND_API_KEY'  // .envì—ì„œ ì„¤ì •
  },
  TELEGRAM: {
    BOT_TOKEN: 'YOUR_TELEGRAM_BOT_TOKEN',  // .envì—ì„œ ì„¤ì •
    CHAT_ID: '-1003635343656'
  },
  AIRTABLE_URL: 'TO_BE_SET'
};

export default {
  async fetch(request) {
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    };

    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    if (request.method !== 'POST') {
      return new Response('Method Not Allowed', { status: 405, headers: corsHeaders });
    }

    try {
      const data = await request.json();
      const results = {
        success: true,
        email: { success: false, error: null },
        telegram: { success: false, error: null }
      };

      try {
        const emailResult = await sendStaffEmail(data);
        results.email = emailResult;
      } catch (error) {
        results.email = { success: false, error: error.message };
      }

      try {
        const telegramResult = await sendTelegramNotification(data);
        results.telegram = telegramResult;
      } catch (error) {
        results.telegram = { success: false, error: error.message };
      }

      return new Response(JSON.stringify(results), {
        status: 200,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });

    } catch (error) {
      return new Response(JSON.stringify({
        success: false,
        error: error.message
      }), {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    }
  }
};

async function sendStaffEmail(data) {
  const platform = data.í”Œë«í¼ || data.platform || 'Meta';
  const adName = data.ê´‘ê³ ëª… || data.adName || '-';
  const location = data.ì§€ì—­ || data.location || '-';
  const name = data.ì´ë¦„ || data.name || '-';
  const phone = formatPhone(data.ì—°ë½ì²˜ || data.phone || '-');
  const company = data.ìƒí˜¸ëª… || data.company || '-';
  const industry = data.ì—…ì¢… || data.industry || '-';
  const revenue = data.ì§ì „ë…„ë„ë§¤ì¶œ || data.revenue || '-';
  const amount = data.í•„ìš”ìê¸ˆ || data.amount || '-';
  const consultTime = data.ìƒë‹´í¬ë§ì‹œê°„ || data.consultTime || '-';

  const platformEmoji = platform.includes('ì¸ìŠ¤íƒ€') ? 'ğŸ“·' : 'ğŸ‘';
  const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

  const subject = `[ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤] ${platformEmoji} Meta ì‹ ê·œ ë¦¬ë“œ - ${company} (${name})`;

  const html = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"></head>
<body style="font-family: 'Pretendard', sans-serif; margin: 0; padding: 0; background: #f5f5f5;">
  <div style="max-width: 600px; margin: 0 auto; background: white;">
    <div style="background: linear-gradient(135deg, #1B4332 0%, #2D6A4F 100%); padding: 30px 20px; text-align: center;">
      <h1 style="margin: 0; color: #ffffff; font-size: 22px; font-weight: 700;">ğŸ’° ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤ ì‹ ê·œ ë¦¬ë“œ</h1>
      <p style="margin: 8px 0 0 0; color: #74C69D; font-size: 14px;">${platformEmoji} ${platform} ê´‘ê³  ì ‘ìˆ˜${adName !== '-' ? ' - ' + adName : ''}</p>
    </div>
    <div style="padding: 20px;">
      <div style="background: #D8F3DC; border-left: 4px solid #52B788; padding: 20px; margin-bottom: 16px; border-radius: 4px;">
        <h3 style="margin: 0 0 16px 0; color: #1B4332; font-size: 16px; font-weight: 700;">ğŸ“‹ ê¸°ë³¸ì •ë³´</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 6px 0; color: #666; width: 100px;">ğŸ¢ ìƒí˜¸ëª…</td><td style="color: #333; font-weight: 600;">${company}</td></tr>
          <tr><td style="padding: 6px 0; color: #666;">ğŸ­ ì—…ì¢…</td><td style="color: #333;">${industry}</td></tr>
          <tr><td style="padding: 6px 0; color: #666;">ğŸ“ ì§€ì—­</td><td style="color: #333;">${location}</td></tr>
        </table>
      </div>
      <div style="background: #D8F3DC; border-left: 4px solid #52B788; padding: 20px; margin-bottom: 16px; border-radius: 4px;">
        <h3 style="margin: 0 0 16px 0; color: #1B4332; font-size: 16px; font-weight: 700;">ğŸ‘¤ ë‹´ë‹¹ì ì •ë³´</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 6px 0; color: #666; width: 100px;">ğŸ‘¤ ì´ë¦„</td><td style="color: #333; font-weight: 600;">${name}</td></tr>
          <tr><td style="padding: 6px 0; color: #666;">ğŸ“ ì—°ë½ì²˜</td><td style="color: #2D6A4F; font-weight: 600;">${phone}</td></tr>
          <tr><td style="padding: 6px 0; color: #666;">ğŸ• ìƒë‹´í¬ë§</td><td style="color: #333;">${consultTime}</td></tr>
        </table>
      </div>
      <div style="background: linear-gradient(135deg, #1B4332 0%, #2D6A4F 100%); padding: 20px; margin-bottom: 16px; border-radius: 4px;">
        <h3 style="margin: 0 0 16px 0; color: #ffffff; font-size: 16px; font-weight: 700;">ğŸ’° ìê¸ˆ ì •ë³´</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 6px 0; color: #74C69D; width: 100px;">ğŸ’µ ì§ì „ë§¤ì¶œ</td><td style="color: #ffffff;">${revenue}</td></tr>
          <tr><td style="padding: 6px 0; color: #74C69D;">ğŸ’° í•„ìš”ìê¸ˆ</td><td style="color: #FFD700; font-weight: 700; font-size: 16px;">${amount}</td></tr>
        </table>
      </div>
      <div style="text-align: center; margin: 24px 0;">
        <a href="${CONFIG.AIRTABLE_URL}" style="display: inline-block; background: linear-gradient(135deg, #52B788, #74C69D); color: white; padding: 14px 32px; text-decoration: none; border-radius: 50px; font-weight: 700; font-size: 14px;">ğŸ“Š Airtableì—ì„œ í™•ì¸í•˜ê¸°</a>
      </div>
      <p style="color: #999; font-size: 12px; text-align: center; margin: 16px 0;">â° ì ‘ìˆ˜ì‹œê°„: ${currentTime}</p>
    </div>
    <div style="background: linear-gradient(135deg, #1B4332 0%, #2D6A4F 100%); padding: 20px; text-align: center;">
      <p style="margin: 0; color: #ffffff; font-weight: 700; font-size: 16px;">ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤</p>
      <p style="margin: 5px 0 0 0; color: #74C69D; font-size: 13px;">ğŸ“ ${CONFIG.BRAND.PHONE}</p>
    </div>
  </div>
</body>
</html>`;

  const response = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + CONFIG.RESEND.API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      from: CONFIG.EMAIL.FROM,
      to: CONFIG.EMAIL.TO,
      bcc: CONFIG.EMAIL.BCC,
      subject: subject,
      html: html
    })
  });

  const result = await response.json();
  if (response.ok) {
    return { success: true, resendId: result.id };
  } else {
    return { success: false, error: result.message || 'Resend error' };
  }
}

async function sendTelegramNotification(data) {
  const platform = data.í”Œë«í¼ || data.platform || 'Meta';
  const adName = data.ê´‘ê³ ëª… || data.adName || '-';
  const location = data.ì§€ì—­ || data.location || '-';
  const name = data.ì´ë¦„ || data.name || '-';
  const phone = formatPhone(data.ì—°ë½ì²˜ || data.phone || '-');
  const company = data.ìƒí˜¸ëª… || data.company || '-';
  const industry = data.ì—…ì¢… || data.industry || '-';
  const revenue = data.ì§ì „ë…„ë„ë§¤ì¶œ || data.revenue || '-';
  const amount = data.í•„ìš”ìê¸ˆ || data.amount || '-';
  const consultTime = data.ìƒë‹´í¬ë§ì‹œê°„ || data.consultTime || '-';

  const platformEmoji = platform.includes('ì¸ìŠ¤íƒ€') ? 'ğŸ“·' : 'ğŸ‘';
  const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

  const message = 'ğŸ’° <b>ì€ì¸ìê¸ˆíŒŒíŠ¸ë„ˆìŠ¤ - Meta ì‹ ê·œë¦¬ë“œ</b>\n' +
    platformEmoji + ' <b>' + platform + '</b>' + (adName !== '-' ? ' | ' + adName : '') + '\n\n' +
    '<b>ğŸ“‹ ê¸°ë³¸ì •ë³´</b>\n' +
    'â”œ ğŸ¢ ìƒí˜¸ëª…: <b>' + company + '</b>\n' +
    'â”œ ğŸ­ ì—…ì¢…: ' + industry + '\n' +
    'â”” ğŸ“ ì§€ì—­: ' + location + '\n\n' +
    '<b>ğŸ‘¤ ë‹´ë‹¹ì</b>\n' +
    'â”œ ì´ë¦„: ' + name + '\n' +
    'â”œ ğŸ“ <code>' + phone + '</code>\n' +
    'â”” â° ìƒë‹´í¬ë§: ' + consultTime + '\n\n' +
    '<b>ğŸ’° ìê¸ˆì •ë³´</b>\n' +
    'â”œ ğŸ’µ ë§¤ì¶œ: ' + revenue + '\n' +
    'â”” ğŸ’° í•„ìš”ìê¸ˆ: <b>' + amount + '</b>\n\n' +
    'ğŸ“Š Airtableì—ì„œ í™•ì¸\n\n' +
    'â° ' + currentTime + '\n' +
    'ğŸ“ ' + CONFIG.BRAND.PHONE;

  const response = await fetch('https://api.telegram.org/bot' + CONFIG.TELEGRAM.BOT_TOKEN + '/sendMessage', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: CONFIG.TELEGRAM.CHAT_ID,
      text: message,
      parse_mode: 'HTML',
      disable_web_page_preview: true
    })
  });

  const result = await response.json();
  if (response.ok && result.ok) {
    return { success: true, messageId: result.result.message_id };
  } else {
    return { success: false, error: result.description || 'Telegram error' };
  }
}

function formatPhone(value) {
  if (!value || value === '-') return '-';
  let digits = String(value).replace(/[^0-9]/g, '');
  if (digits.startsWith('82')) {
    digits = '0' + digits.substring(2);
  }
  if (!digits.startsWith('0')) {
    digits = '0' + digits;
  }
  if (digits.length === 11 && digits.startsWith('010')) {
    return digits.slice(0, 3) + '-' + digits.slice(3, 7) + '-' + digits.slice(7);
  } else if (digits.length === 10) {
    return digits.slice(0, 3) + '-' + digits.slice(3, 6) + '-' + digits.slice(6);
  }
  return value;
}
